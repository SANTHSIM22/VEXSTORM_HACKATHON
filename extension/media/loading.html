<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'none'; script-src 'nonce-{{nonce}}'; style-src 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src https://fonts.gstatic.com; img-src {{cspSource}} https: data: blob:;" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZeroTrace — Scanning</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #0d0f12;
      --surface:     #13161c;
      --surface-2:   #1a1e27;
      --surface-3:   #20252f;
      --border:      #262c38;
      --border-2:    #2e3545;
      --text:        #dce3ef;
      --text-mid:    #9aa3ba;
      --text-dim:    #6b7690;
      --text-muted:  #3f4a5c;
      --accent:      #3b82f6;
      --accent-dim:  rgba(59,130,246,.10);
      --accent-glow: rgba(59,130,246,.20);
      --success:     #4caf50;
      --success-dim: rgba(76,175,80,.10);
      --warn:        #fb8c00;
      --font-sans:   'IBM Plex Sans', sans-serif;
      --font-mono:   'IBM Plex Mono', monospace;
      --radius:      4px;
      --radius-lg:   6px;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 24px 32px;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-2); border-radius: 2px; }

    /* ── Header ── */
    .header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 36px;
      user-select: none;
    }

    .logo-mark {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 6px;
    }

    .logo-mark img {
      width: 44px;
      height: 44px;
      object-fit: contain;
    }

    .header-title {
      font-family: var(--font-mono);
      font-size: 15px;
      font-weight: 500;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text);
    }

    .header-sub {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    /* ── Status section ── */
    .status-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      width: 100%;
      max-width: 480px;
    }

    /* ── Progress ring ── */
    .progress-container {
      position: relative;
      width: 72px;
      height: 72px;
    }

    .progress-ring {
      transform: rotate(-90deg);
      width: 72px;
      height: 72px;
    }

    .progress-ring-bg {
      fill: none;
      stroke: var(--surface-3);
      stroke-width: 2.5;
    }

    .progress-ring-fill {
      fill: none;
      stroke: var(--accent);
      stroke-width: 2.5;
      stroke-linecap: butt;
      stroke-dasharray: 188.5;
      stroke-dashoffset: 188.5;
      transition: stroke-dashoffset 0.55s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-inner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0;
    }

    .progress-pct {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      line-height: 1;
    }

    .progress-pulse {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--accent);
      margin-top: 4px;
      animation: blink 1.4s step-start infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0; }
    }

    /* ── Stage info ── */
    .stage-info {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }

    #stage {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      letter-spacing: -.01em;
      min-height: 20px;
    }

    #msg {
      font-size: 11px;
      color: var(--text-dim);
      min-height: 16px;
      max-width: 380px;
      line-height: 1.5;
    }

    /* ── Elapsed ── */
    .elapsed {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: .06em;
    }

    /* ── Pipeline section ── */
    .pipeline-section {
      width: 100%;
      max-width: 480px;
      margin-bottom: 20px;
    }

    .section-label {
      font-size: 9px;
      font-weight: 600;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
      padding-left: 1px;
    }

    /* ── Pipeline card ── */
    .pipeline {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }

    .agent {
      display: grid;
      grid-template-columns: 6px 1fr auto auto;
      align-items: center;
      gap: 12px;
      padding: 9px 16px;
      border-bottom: 1px solid var(--border);
      transition: background .2s;
      position: relative;
    }

    .agent:last-child {
      border-bottom: none;
    }

    /* ── Indicator dot ── */
    .agent-indicator {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--surface-3);
      flex-shrink: 0;
      transition: background .25s, box-shadow .25s;
    }

    /* ── Agent label ── */
    .agent-label {
      font-size: 12px;
      font-weight: 400;
      color: var(--text-muted);
      transition: color .2s;
      white-space: nowrap;
    }

    /* ── Status badge ── */
    .agent-status {
      font-family: var(--font-mono);
      font-size: 9px;
      font-weight: 500;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: transparent;
      min-width: 48px;
      text-align: right;
      transition: color .2s;
    }

    /* ── Agent timer ── */
    .agent-timer {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      min-width: 28px;
      text-align: right;
      transition: color .2s;
    }

    /* ── Waiting state ── */
    .agent.waiting .agent-indicator { background: var(--surface-3); }
    .agent.waiting .agent-label     { color: var(--text-muted); }

    /* ── Active state ── */
    .agent.active {
      background: var(--accent-dim);
    }

    .agent.active .agent-indicator {
      background: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
      animation: dotPulse 1.6s ease-in-out infinite;
    }

    .agent.active .agent-label   { color: var(--text); font-weight: 500; }
    .agent.active .agent-status  { color: var(--accent); }
    .agent.active .agent-timer   { color: var(--accent); }

    @keyframes dotPulse {
      0%, 100% { box-shadow: 0 0 0 2px rgba(59,130,246,.15); }
      50%       { box-shadow: 0 0 0 4px rgba(59,130,246,.30); }
    }

    /* ── Done state ── */
    .agent.done {
      background: transparent;
    }

    .agent.done .agent-indicator { background: var(--success); }
    .agent.done .agent-label     { color: var(--text-dim); }
    .agent.done .agent-status    { color: var(--success); }
    .agent.done .agent-timer     { color: var(--text-muted); }

    /* ── Scan complete state ── */
    .agent.complete {
      background: var(--success-dim);
    }
    .agent.complete .agent-indicator { background: var(--success); }
    .agent.complete .agent-label     { color: var(--text); font-weight: 500; }
    .agent.complete .agent-status    { color: var(--success); }

    /* ── Log section ── */
    .log-section {
      width: 100%;
      max-width: 480px;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .log-header .section-label { margin-bottom: 0; }

    .log-count {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
    }

    #log {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border-2) transparent;
    }

    .log-entry {
      display: grid;
      grid-template-columns: 52px 1fr;
      gap: 12px;
      align-items: baseline;
      padding: 3px 0;
      border-bottom: 1px solid var(--border);
      font-family: var(--font-mono);
      font-size: 11px;
      line-height: 1.6;
    }

    .log-entry:last-child { border-bottom: none; }

    .log-time { color: var(--text-muted); font-size: 10px; }
    .log-text { color: var(--text-dim); word-break: break-word; }
    .log-entry:last-child .log-text { color: var(--text-mid); }

    .log-entry.log--ok    .log-text { color: #4caf50; }
    .log-entry.log--warn  .log-text { color: var(--warn); }
    .log-entry.log--error .log-text { color: #e53935; }

    .log-empty {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
      padding: 2px 0;
    }

    /* ── Footer ── */
    .footer {
      margin-top: 28px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      letter-spacing: .04em;
    }

    .footer-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--accent);
      animation: blink 1.4s step-start infinite;
    }

    body.scan-complete .footer-dot {
      animation: none;
      background: var(--success);
    }

    body.scan-complete .progress-pulse {
      display: none;
    }

    /* ── Progress bar (linear, below ring) ── */
    .progress-bar-wrap {
      width: 100%;
      max-width: 480px;
      margin-bottom: 4px;
    }

    .progress-bar-track {
      height: 2px;
      background: var(--surface-3);
      border-radius: 1px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 1px;
      width: 0%;
      transition: width .55s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-bar-label {
      display: flex;
      justify-content: space-between;
      font-family: var(--font-mono);
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 5px;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="logo-mark">
      <img src="{{logoUri}}" alt="ZeroTrace">
    </div>
    <div class="header-title">ZeroTrace</div>
    <div class="header-sub">Security Analysis</div>
  </div>

  <!-- Status -->
  <div class="status-section">
    <div class="progress-container">
      <svg class="progress-ring" viewBox="0 0 72 72">
        <defs>
          <linearGradient id="pg" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#3b82f6"/>
            <stop offset="100%" stop-color="#60a5fa"/>
          </linearGradient>
        </defs>
        <circle class="progress-ring-bg" cx="36" cy="36" r="30"/>
        <circle class="progress-ring-fill" id="progressCircle" cx="36" cy="36" r="30"/>
      </svg>
      <div class="progress-inner">
        <span class="progress-pct" id="progressPercent">0%</span>
        <div class="progress-pulse" id="progressPulse"></div>
      </div>
    </div>

    <div class="stage-info">
      <div id="stage">Initializing</div>
      <div id="msg">Preparing agent pipeline</div>
    </div>

    <div class="elapsed" id="elapsed">00:00</div>
  </div>

  <!-- Linear progress bar -->
  <div class="progress-bar-wrap">
    <div class="progress-bar-track">
      <div class="progress-bar-fill" id="progressBar"></div>
    </div>
    <div class="progress-bar-label">
      <span id="progressBarLeft">0 / 11 agents</span>
      <span id="progressBarRight">0%</span>
    </div>
  </div>

  <!-- Pipeline -->
  <div class="pipeline-section" style="margin-top:20px">
    <div class="section-label">Agent Pipeline</div>
    <div class="pipeline">
      <div class="agent waiting" id="a-scanner">
        <div class="agent-indicator"></div>
        <span class="agent-label">File Scanner</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-pattern">
        <div class="agent-indicator"></div>
        <span class="agent-label">Pattern Detection</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-auth">
        <div class="agent-indicator"></div>
        <span class="agent-label">Authentication Analysis</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-biz">
        <div class="agent-indicator"></div>
        <span class="agent-label">Business Logic</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-api">
        <div class="agent-indicator"></div>
        <span class="agent-label">API Security</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-frontend">
        <div class="agent-indicator"></div>
        <span class="agent-label">Frontend Security</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-infra">
        <div class="agent-indicator"></div>
        <span class="agent-label">Infrastructure</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-crypto">
        <div class="agent-indicator"></div>
        <span class="agent-label">Cryptography &amp; Logging</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-llm">
        <div class="agent-indicator"></div>
        <span class="agent-label">AI Deep Analysis</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-verifier">
        <div class="agent-indicator"></div>
        <span class="agent-label">Verification</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
      <div class="agent waiting" id="a-reporter">
        <div class="agent-indicator"></div>
        <span class="agent-label">Report Generation</span>
        <span class="agent-status">--</span>
        <span class="agent-timer"></span>
      </div>
    </div>
  </div>

  <!-- Log -->
  <div class="log-section">
    <div class="log-header">
      <span class="section-label">Output Log</span>
      <span class="log-count" id="logCount">0 entries</span>
    </div>
    <div id="log">
      <div class="log-empty">Waiting for agents to start...</div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-dot"></div>
    <span id="footerLabel">Pipeline running</span>
  </div>

  <script nonce="{{nonce}}">
    const vscode = typeof acquireVsCodeApi !== 'undefined' ? acquireVsCodeApi() : null;

    const stageMap = {
      'Scanning Files':             'a-scanner',
      'Pattern Analysis':           'a-pattern',
      'Auth Analysis':              'a-auth',
      'Business Logic Analysis':    'a-biz',
      'API Security Analysis':      'a-api',
      'Frontend Security Analysis': 'a-frontend',
      'Infrastructure Analysis':    'a-infra',
      'Crypto & Logging Analysis':  'a-crypto',
      'AI Analysis':                'a-llm',
      'Verifying Findings':         'a-verifier',
      'Generating Report':          'a-reporter',
    };

    const agentOrder = [
      'a-scanner', 'a-pattern', 'a-auth', 'a-biz', 'a-api',
      'a-frontend', 'a-infra', 'a-crypto', 'a-llm', 'a-verifier', 'a-reporter'
    ];

    const TOTAL = agentOrder.length;
    let activeAgent    = null;
    let completedCount = 0;
    let logEntryCount  = 0;
    let startTime      = Date.now();
    let agentStartTimes = {};

    /* ── Circumference for r=30 ── */
    const CIRC = 2 * Math.PI * 30;
    const circle = document.getElementById('progressCircle');
    circle.style.strokeDasharray  = CIRC;
    circle.style.strokeDashoffset = CIRC;

    function setProgress(fraction) {
      const pct = Math.round(fraction * 100);
      circle.style.strokeDashoffset = CIRC - fraction * CIRC;
      document.getElementById('progressPercent').textContent  = pct + '%';
      document.getElementById('progressBar').style.width      = pct + '%';
      document.getElementById('progressBarLeft').textContent  = completedCount + ' / ' + TOTAL + ' agents';
      document.getElementById('progressBarRight').textContent = pct + '%';
    }

    /* ── Elapsed timer ── */
    const elapsedEl = document.getElementById('elapsed');

    setInterval(() => {
      const diff = Math.floor((Date.now() - startTime) / 1000);
      elapsedEl.textContent =
        String(Math.floor(diff / 60)).padStart(2, '0') + ':' +
        String(diff % 60).padStart(2, '0');

      /* live-update active agent timer */
      if (activeAgent && agentStartTimes[activeAgent]) {
        const agentDiff = Math.floor((Date.now() - agentStartTimes[activeAgent]) / 1000);
        const el = document.getElementById(activeAgent);
        if (el) {
          const t = el.querySelector('.agent-timer');
          if (t) t.textContent = agentDiff + 's';
        }
      }
    }, 1000);

    /* ── Timestamp ── */
    function ts() {
      const n = new Date();
      return [n.getHours(), n.getMinutes(), n.getSeconds()]
        .map(v => String(v).padStart(2, '0')).join(':');
    }

    /* ── Log helper ── */
    function appendLog(text) {
      if (!text) return;
      const log = document.getElementById('log');

      /* remove placeholder */
      const empty = log.querySelector('.log-empty');
      if (empty) empty.remove();

      const cls =
        /error|fail/i.test(text)    ? 'log--error' :
        /warn|skip/i.test(text)     ? 'log--warn'  :
        /complete|done|found/i.test(text) ? 'log--ok' : '';

      const entry = document.createElement('div');
      entry.className = 'log-entry' + (cls ? ' ' + cls : '');
      const timeEl = document.createElement('span');
      timeEl.className = 'log-time';
      timeEl.textContent = ts();
      const textEl = document.createElement('span');
      textEl.className = 'log-text';
      textEl.textContent = text;  /* textContent — safe, no XSS */
      entry.appendChild(timeEl);
      entry.appendChild(textEl);
      log.appendChild(entry);
      log.scrollTop = log.scrollHeight;

      logEntryCount++;
      document.getElementById('logCount').textContent =
        logEntryCount + (logEntryCount === 1 ? ' entry' : ' entries');
    }

    /* ── Message handler ── */
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || msg.type !== 'progress') return;

      document.getElementById('stage').textContent = msg.stage   || '';
      document.getElementById('msg').textContent   = msg.message || '';

      const agentId = stageMap[msg.stage];

      if (agentId && agentId !== activeAgent) {
        /* close previous */
        if (activeAgent) {
          const prev = document.getElementById(activeAgent);
          if (prev) {
            prev.classList.remove('active', 'waiting');
            prev.classList.add('done');
            const s = prev.querySelector('.agent-status');
            if (s) s.textContent = 'done';
            if (agentStartTimes[activeAgent]) {
              const elapsed = Math.floor((Date.now() - agentStartTimes[activeAgent]) / 1000);
              const t = prev.querySelector('.agent-timer');
              if (t) t.textContent = elapsed + 's';
            }
          }
          completedCount++;
        }

        /* open new */
        const curr = document.getElementById(agentId);
        if (curr) {
          curr.classList.remove('waiting', 'done');
          curr.classList.add('active');
          const s = curr.querySelector('.agent-status');
          if (s) s.textContent = 'running';
        }

        activeAgent = agentId;
        agentStartTimes[agentId] = Date.now();
        setProgress(completedCount / TOTAL);
      }

      /* complete signal */
      if (msg.stage === 'Complete' || msg.complete) {
        /* mark last agent done */
        if (activeAgent) {
          const el = document.getElementById(activeAgent);
          if (el) {
            el.classList.remove('active', 'waiting');
            el.classList.add('done');
            const s = el.querySelector('.agent-status');
            if (s) s.textContent = 'done';
          }
          completedCount = TOTAL;
          activeAgent = null;
        }
        setProgress(1);
        document.body.classList.add('scan-complete');
        document.getElementById('footerLabel').textContent = 'Scan complete';
        document.getElementById('stage').textContent = 'Complete';
        document.getElementById('progressPulse').style.display = 'none';
      }

      appendLog(msg.message);
    });
  </script>
</body>
</html>